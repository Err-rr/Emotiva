import streamlit as st
from transformers import pipeline
from deep_translator import GoogleTranslator
from gtts import gTTS
from datetime import datetime

# --------- UI + Styling ---------
st.set_page_config(page_title="Emotiva", layout="wide")

st.markdown("""
    <style>
    body {
        background-color: #fffaf0;
    }
    .main {
        background-color: #fffaf0;
    }
    h1, h4 {
        color: #0d47a1;
    }
    .st-emotion-cache-1v0mbdj, .st-emotion-cache-1avcm0n {
        color: black !important;
    }
    
    /* Layout styles */
    .left-panel {
        padding: 20px;
        text-align: center;
    }
    .right-panel {
        padding: 20px;
    }
    .language-selector {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    </style>
    """, unsafe_allow_html=True)

# --------- Language Configuration ---------
LANGUAGES = {
    'English': {'code': 'en', 'tts': 'en'},
    'рд╣рд┐рдиреНрджреА': {'code': 'hi', 'tts': 'hi'},
    'Hinglish': {'code': 'en', 'tts': 'en'},
    'родрооро┐ро┤рпН': {'code': 'ta', 'tts': 'ta'},
    'р░др▒Жр░▓р▒Бр░Чр▒Б': {'code': 'te', 'tts': 'te'},
    'ржмрж╛ржВрж▓рж╛': {'code': 'bn', 'tts': 'bn'},
    'рдорд░рд╛рдареА': {'code': 'mr', 'tts': 'mr'}
}

# --------- Load Models & States ---------
@st.cache_resource
def load_model():
    return pipeline("text-classification", model="j-hartmann/emotion-english-distilroberta-base", top_k=None)

classifier = load_model()

if "chat_history" not in st.session_state:
    st.session_state.chat_history = []

if "selected_language" not in st.session_state:
    st.session_state.selected_language = 'English'

# --------- Language Detection ---------
def detect_language(text):
    try:
        translated = GoogleTranslator(source='auto', target='en').translate(text)
        return 'hi' if translated != text else 'en'
    except:
        return 'en'

# --------- Emotion Detection ---------
def detect_emotion(text):
    result = classifier(text)[0]
    top = max(result, key=lambda x: x['score'])
    return top['label'].lower()

# --------- Generate Female Reply ---------
def generate_reply(user_input, emotion, language):
    user_input_lower = user_input.lower()

    if any(greet in user_input_lower for greet in ["hi", "hello", "hey", "heyy"]):
        core = {
            'English': "Hello dear! How are you doing today? I'm here to help you with anything you need! тЬи",
            'рд╣рд┐рдиреНрджреА': "рдирдорд╕реНрддреЗ рдкреНрд░рд┐рдп! рдЖрдк рдХреИрд╕реЗ рд╣реИрдВ? рдореИрдВ рдЖрдкрдХреА рд╣рд░ рдмрд╛рдд рдореЗрдВ рдорджрдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдБ рд╣реВрдБ! тЬи",
            'Hinglish': "Hello dear! Aap kaise hain? Main aapki har help karne ke liye yahan hun! тЬи",
            'родрооро┐ро┤рпН': "ро╡рогроХрпНроХроорпН роЕройрпНрокрпЗ! роирпАроЩрпНроХро│рпН роОрокрпНрокроЯро┐ роЗро░рпБроХрпНроХро┐ро▒рпАро░рпНроХро│рпН? роиро╛ройрпН роЙроЩрпНроХро│рпБроХрпНроХрпБ роОро▓рпНро▓ро╛ро╡ро▒рпНро▒ро┐ро▓рпБроорпН роЙродро╡ роЗроЩрпНроХрпЗ роЗро░рпБроХрпНроХро┐ро▒рпЗройрпН! тЬи",
            'р░др▒Жр░▓р▒Бр░Чр▒Б': "р░ир░ор░╕р▒Нр░Хр░╛р░░р░В р░кр▒Нр░░р░┐р░пр░ор▒Ир░и! р░ор▒Ар░░р▒Б р░Ор░▓р░╛ р░Йр░ир▒Нр░ир░╛р░░р▒Б? р░ир▒Зр░ир▒Б р░ор▒Ар░Хр▒Б р░Ер░ир▒Нр░ир░┐ р░╡р░┐р░╖р░пр░╛р░▓р▒Нр░▓р▒Л р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░бр░╛р░ир░┐р░Хр░┐ р░Зр░Хр▒Нр░Хр░б р░Йр░ир▒Нр░ир░╛р░ир▒Б! тЬи",
            'ржмрж╛ржВрж▓рж╛': "ржиржорж╕рзНржХрж╛рж░ ржкрзНрж░рж┐ржпрж╝! ржЖржкржирж┐ ржХрзЗржоржи ржЖржЫрзЗржи? ржЖржорж┐ ржЖржкржирж╛рж░ рж╕ржм ржХрж┐ржЫрзБрждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рждрзЗ ржПржЦрж╛ржирзЗ ржЖржЫрж┐! тЬи",
            'рдорд░рд╛рдареА': "рдирдорд╕реНрдХрд╛рд░ рдкреНрд░рд┐рдп! рддреБрдореНрд╣реА рдХрд╕реЗ рдЖрд╣рд╛рдд? рдореА рддреБрдордЪреНрдпрд╛ рд╕рд░реНрд╡ рдЧреЛрд╖реНрдЯреАрдВрдордзреНрдпреЗ рдорджрдд рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рдЗрдереЗ рдЖрд╣реЗ! тЬи"
        }
    elif any(q in user_input_lower for q in ["help", "issue", "problem", "confused", "can't"]):
        core = {
            'English': "Oh sweetie, I'm here to help you through this! Please tell me more about what's troubling you, and I'll do my best to assist you! ЁЯТЩ",
            'рд╣рд┐рдиреНрджреА': "рдЕрд░реЗ рдкреНрдпрд╛рд░реЗ, рдореИрдВ рдЖрдкрдХреА рд╣рд░ рдкрд░реЗрд╢рд╛рдиреА рдореЗрдВ рдЖрдкрдХреЗ рд╕рд╛рде рд╣реВрдБ! рдХреГрдкрдпрд╛ рдЕрдкрдиреА рд╕рдорд╕реНрдпрд╛ рдмрддрд╛рдПрдВ, рдореИрдВ рдкреВрд░реА рдХреЛрд╢рд┐рд╢ рдХрд░реВрдВрдЧреА! ЁЯТЩ",
            'Hinglish': "Oh sweetie, main aapki har problem mein help karungi! Please batao kya issue hai, main puri koshish karungi! ЁЯТЩ",
            'родрооро┐ро┤рпН': "роУ роЕройрпНрокрпЗ, роЗродро┐ро▓рпН роЙроЩрпНроХро│рпБроХрпНроХрпБ роЙродро╡ роиро╛ройрпН роЗроЩрпНроХрпЗ роЗро░рпБроХрпНроХро┐ро▒рпЗройрпН! роЙроЩрпНроХро│рпИ родрпКроирпНродро░ро╡рпБ роЪрпЖропрпНро╡родрпБ роОройрпНройро╡рпЖройрпНро▒рпБ роЪрпКро▓рпНро▓рпБроЩрпНроХро│рпН, роиро╛ройрпН роорпБроЯро┐роирпНрод роЙродро╡ро┐ роЪрпЖропрпНро╡рпЗройрпН! ЁЯТЩ",
            'р░др▒Жр░▓р▒Бр░Чр▒Б': "р░У р░Ър▒Жр░▓р▒Нр░▓р▒А, р░И р░╡р░┐р░╖р░пр░Вр░▓р▒Л р░ор▒Ар░Хр▒Б р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░бр░╛р░ир░┐р░Хр░┐ р░ир▒Зр░ир▒Б р░Зр░Хр▒Нр░Хр░б р░Йр░ир▒Нр░ир░╛р░ир▒Б! р░ор░┐р░ор▒Нр░ор░▓р▒Нр░ир░┐ р░Зр░мр▒Нр░мр░Вр░жр░┐ р░кр▒Жр░Яр▒Нр░Яр▒Зр░жр░┐ р░Пр░ор░┐р░Яр▒Л р░Ър▒Жр░кр▒Нр░кр░Вр░бр░┐, р░ир▒Зр░ир▒Б р░ир░╛ р░╡р░Вр░др▒Б р░╕р░╣р░╛р░пр░В р░Ър▒Зр░╕р▒Нр░др░╛р░ир▒Б! ЁЯТЩ",
            'ржмрж╛ржВрж▓рж╛': "ржУрж╣ рж╕рзЛржирж╛, ржЖржорж┐ ржПржЦрж╛ржирзЗ ржЖржкржирж╛рж░ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рждрзЗ ржЖржЫрж┐! ржЖржкржирж╛рж░ ржХрзА рж╕ржорж╕рзНржпрж╛ рж╣ржЪрзНржЫрзЗ рждрж╛ ржмрж▓рзБржи, ржЖржорж┐ ржпржерж╛рж╕рж╛ржзрзНржп рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░ржм! ЁЯТЩ",
            'рдорд░рд╛рдареА': "рдЕрд░реЗ рдкреНрд░рд┐рдп, рдореА рддреБрдордЪреНрдпрд╛ рдорджрддреАрд╕рд╛рдареА рдЗрдереЗ рдЖрд╣реЗ! рддреБрдореНрд╣рд╛рд▓рд╛ рдХрд╛рдп рддреНрд░рд╛рд╕ рд╣реЛрдд рдЖрд╣реЗ рддреЗ рд╕рд╛рдВрдЧрд╛, рдореА рдорд╛рдЭреА рдкреВрд░реНрдг рдорджрдд рдХрд░реЗрди! ЁЯТЩ"
        }
    elif any(q in user_input_lower for q in ["order", "delivery", "refund", "status"]):
        core = {
            'English': "Of course honey! I'd be happy to help you with your order. Could you please share more details so I can assist you better? ЁЯМ╕",
            'рд╣рд┐рдиреНрджреА': "рдмрд┐рд▓реНрдХреБрд▓ рдкреНрд░рд┐рдп! рдореИрдВ рдЖрдкрдХреА рдСрд░реНрдбрд░ рдореЗрдВ рдЦреБрд╢реА рд╕реЗ рдорджрдж рдХрд░реВрдВрдЧреАред рдХреГрдкрдпрд╛ рдФрд░ рдЬрд╛рдирдХрд╛рд░реА рджреЗрдВ рддрд╛рдХрд┐ рдореИрдВ рдмреЗрд╣рддрд░ рд╕рд╣рд╛рдпрддрд╛ рдХрд░ рд╕рдХреВрдВ! ЁЯМ╕",
            'Hinglish': "Bilkul honey! Main aapki order mein khushi se help karungi. Please aur details share karo taki main better assist kar sakun! ЁЯМ╕",
            'родрооро┐ро┤рпН': "роиро┐роЪрпНроЪропрооро╛роХ роЕройрпНрокрпЗ! роЙроЩрпНроХро│рпН роЖро░рпНроЯро░рпБроХрпНроХрпБ роЙродро╡ роиро╛ройрпН роороХро┐ро┤рпНроЪрпНроЪро┐ропро╛роХ роЗро░рпБроХрпНроХро┐ро▒рпЗройрпН. роорпЗро▓рпБроорпН ро╡ро┐ро╡ро░роЩрпНроХро│рпИрокрпН рокроХро┐ро░рпНроирпНродрпБ роХрпКро│рпНро│рпБроЩрпНроХро│рпН, роиро╛ройрпН роЪро┐ро▒рокрпНрокро╛роХ роЙродро╡ роорпБроЯро┐ропрпБроорпН! ЁЯМ╕",
            'р░др▒Жр░▓р▒Бр░Чр▒Б': "р░Ер░пр▒Нр░пр▒Л р░Цр░Ър▒Нр░Ър░┐р░др░Вр░Чр░╛! р░ор▒А р░Жр░░р▒Нр░бр░░р▒НтАМр░▓р▒Л р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░бр░╛р░ир░┐р░Хр░┐ р░ир▒Зр░ир▒Б р░╕р░Вр░др▒Лр░╖р░┐р░╕р▒Нр░др░╛р░ир▒Б. р░ор░░р░┐р░Вр░д р░╡р░┐р░╡р░░р░╛р░▓р▒Б р░╖р▒Зр░░р▒Н р░Ър▒Зр░пр░Вр░бр░┐, р░ир▒Зр░ир▒Б р░ор░Вр░Ър░┐р░Чр░╛ р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░Чр░▓р░ир▒Б! ЁЯМ╕",
            'ржмрж╛ржВрж▓рж╛': "ржЕржмрж╢рзНржпржЗ ржкрзНрж░рж┐ржпрж╝! ржЖржкржирж╛рж░ ржЕрж░рзНржбрж╛рж░рзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рждрзЗ ржЖржорж┐ ржЦрзБрж╢рж┐ рж╣ржмред ржЖрж░ржУ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржЬрж╛ржирж╛ржи ржпрж╛рждрзЗ ржЖржорж┐ ржЖрж░ржУ ржнрж╛рж▓рзЛ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рждрзЗ ржкрж╛рж░рж┐! ЁЯМ╕",
            'рдорд░рд╛рдареА': "рдирдХреНрдХреАрдЪ рдкреНрд░рд┐рдп! рддреБрдордЪреНрдпрд╛ рдСрд░реНрдбрд░рдордзреНрдпреЗ рдорджрдд рдХрд░рдгреНрдпрд╛рдд рдорд▓рд╛ рдЖрдирдВрдж рд╣реЛрдИрд▓ред рдЕрдзрд┐рдХ рддрдкрд╢реАрд▓ рджреНрдпрд╛ рдЬреЗрдгреЗрдХрд░реВрди рдореА рдЪрд╛рдВрдЧрд▓реА рдорджрдд рдХрд░реВ рд╢рдХреЗрди! ЁЯМ╕"
        }
    else:
        core = {
            'English': "Thank you so much for your message, dear! I'm here and ready to help you with whatever you need! How can I make your day better? ЁЯШК",
            'рд╣рд┐рдиреНрджреА': "рдЖрдкрдХреЗ рд╕рдВрджреЗрд╢ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдзрдиреНрдпрд╡рд╛рдж рдкреНрд░рд┐рдп! рдореИрдВ рдпрд╣рд╛рдБ рд╣реВрдБ рдФрд░ рдЖрдкрдХреА рд╣рд░ рдЬрд░реВрд░рдд рдореЗрдВ рдорджрдж рдХрд░рдиреЗ рдХреЛ рддреИрдпрд╛рд░ рд╣реВрдБ! рдЖрдкрдХрд╛ рджрд┐рди рдХреИрд╕реЗ рдмреЗрд╣рддрд░ рдмрдирд╛рдКрдВ? ЁЯШК",
            'Hinglish': "Thank you so much dear! Main yahan hun aur aapki har need mein help karne ko ready hun! Aapka din kaise better banau? ЁЯШК",
            'родрооро┐ро┤рпН': "роЙроЩрпНроХро│рпН роЪрпЖропрпНродро┐роХрпНроХрпБ рооро┐роХрпНроХ роиройрпНро▒ро┐ роЕройрпНрокрпЗ! роиро╛ройрпН роЗроЩрпНроХрпЗ роЗро░рпБроХрпНроХро┐ро▒рпЗройрпН, роЙроЩрпНроХро│рпБроХрпНроХрпБ родрпЗро╡рпИропро╛рой роОродро┐ро▓рпБроорпН роЙродро╡ родропро╛ро░рпН! роЙроЩрпНроХро│рпН роиро╛ро│рпИ роОрокрпНрокроЯро┐ роЪро┐ро▒рокрпНрокро╛роХрпНроХро▓ро╛роорпН? ЁЯШК",
            'р░др▒Жр░▓р▒Бр░Чр▒Б': "р░ор▒А р░╕р░Вр░жр▒Зр░╢р░╛р░ир░┐р░Хр░┐ р░Ър░╛р░▓р░╛ р░зр░ир▒Нр░пр░╡р░╛р░жр░╛р░▓р▒Б р░кр▒Нр░░р░┐р░пр░ор▒Ир░и! р░ир▒Зр░ир▒Б р░Зр░Хр▒Нр░Хр░б р░Йр░ир▒Нр░ир░╛р░ир▒Б, р░ор▒Ар░Хр▒Б р░Ер░╡р░╕р░░р░ор▒Ир░и р░жр▒Зр░ир░┐р░▓р▒Лр░ир▒Ир░ир░╛ р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░бр░╛р░ир░┐р░Хр░┐ р░╕р░┐р░жр▒Нр░зр░Вр░Чр░╛ р░Йр░ир▒Нр░ир░╛р░ир▒Б! р░ор▒А р░░р▒Лр░Ьр▒Бр░ир▒Б р░Ор░▓р░╛ р░ор▒Жр░░р▒Бр░Чр▒Бр░кр░░р░Ър░╛р░▓р░┐? ЁЯШК",
            'ржмрж╛ржВрж▓рж╛': "ржЖржкржирж╛рж░ ржмрж╛рж░рзНрждрж╛рж░ ржЬржирзНржп ржЕржирзЗржХ ржзржирзНржпржмрж╛ржж ржкрзНрж░рж┐ржпрж╝! ржЖржорж┐ ржПржЦрж╛ржирзЗ ржЖржЫрж┐ ржПржмржВ ржЖржкржирж╛рж░ ржпрж╛ ржкрзНрж░ржпрж╝рзЛржЬржи рждрж╛рждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рждрзЗ ржкрзНрж░рж╕рзНрждрзБржд! ржЖржкржирж╛рж░ ржжрж┐ржиржЯрж┐ ржХрзАржнрж╛ржмрзЗ ржЖрж░ржУ ржнрж╛рж▓рзЛ ржХрж░рждрзЗ ржкрж╛рж░рж┐? ЁЯШК",
            'рдорд░рд╛рдареА': "рддреБрдордЪреНрдпрд╛ рд╕рдВрджреЗрд╢рд╛рд╕рд╛рдареА рдЦреВрдк рдзрдиреНрдпрд╡рд╛рдж рдкреНрд░рд┐рдп! рдореА рдЗрдереЗ рдЖрд╣реЗ рдЖрдгрд┐ рддреБрдордЪреА рдЬреА рдЧрд░рдЬ рдЕрд╕реЗрд▓ рддреНрдпрд╛рдордзреНрдпреЗ рдорджрдд рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рддрдпрд╛рд░ рдЖрд╣реЗ! рддреБрдордЪрд╛ рджрд┐рд╡рд╕ рдХрд╕рд╛ рдЪрд╛рдВрдЧрд▓рд╛ рдХрд░реВ? ЁЯШК"
        }

    empathy = {
        'happy': {
            'English': "I can feel your positive energy radiating through! ЁЯМЯ ",
            'рд╣рд┐рдиреНрджреА': "рдореИрдВ рдЖрдкрдХреА рд╕рдХрд╛рд░рд╛рддреНрдордХ рдКрд░реНрдЬрд╛ рдорд╣рд╕реВрд╕ рдХрд░ рд╕рдХрддреА рд╣реВрдБ! ЁЯМЯ ",
            'Hinglish': "Main aapki positive energy feel kar sakti hun! ЁЯМЯ ",
            'родрооро┐ро┤рпН': "роЙроЩрпНроХро│рпН роирпЗро░рпНрооро▒рпИ роЖро▒рпНро▒ро▓рпИ роОройрпНройро╛ро▓рпН роЙрогро░ роорпБроЯро┐роХро┐ро▒родрпБ! ЁЯМЯ ",
            'р░др▒Жр░▓р▒Бр░Чр▒Б': "р░ор▒А р░╕р░╛р░ир▒Бр░Хр▒Вр░▓ р░╢р░Хр▒Нр░др░┐р░ир░┐ р░ир▒Зр░ир▒Б р░Ер░ир▒Бр░нр░╡р░┐р░Вр░Ър░Чр░▓р░ир▒Б! ЁЯМЯ ",
            'ржмрж╛ржВрж▓рж╛': "ржЖржорж┐ ржЖржкржирж╛рж░ ржЗрждрж┐ржмрж╛ржЪржХ рж╢ржХрзНрждрж┐ ржЕржирзБржнржм ржХрж░рждрзЗ ржкрж╛рж░ржЫрж┐! ЁЯМЯ ",
            'рдорд░рд╛рдареА': "рдореА рддреБрдордЪреА рд╕рдХрд╛рд░рд╛рддреНрдордХ рдКрд░реНрдЬрд╛ рдЬрд╛рдгрд╡реВ рд╢рдХрддреЗ! ЁЯМЯ "
        },
        'sad': {
            'English': "I can sense you're feeling down, sweetheart. I'm here for you. ЁЯТХ ",
            'рд╣рд┐рдиреНрджреА': "рдореИрдВ рдорд╣рд╕реВрд╕ рдХрд░ рд╕рдХрддреА рд╣реВрдБ рдХрд┐ рдЖрдк рдЙрджрд╛рд╕ рд╣реИрдВ рдкреНрд░рд┐рдпред рдореИрдВ рдЖрдкрдХреЗ рд╕рд╛рде рд╣реВрдБред ЁЯТХ ",
            'Hinglish': "Main feel kar sakti hun ki aap sad hain dear. Main aapke saath hun. ЁЯТХ ",
            'родрооро┐ро┤рпН': "роирпАроЩрпНроХро│рпН ро╡ро░рпБродрпНродрооро╛роХ роЙрогро░рпНроХро┐ро▒рпАро░рпНроХро│рпН роОройрпНрокродрпИ роОройрпНройро╛ро▓рпН роЙрогро░ роорпБроЯро┐роХро┐ро▒родрпБ роЕройрпНрокрпЗред роиро╛ройрпН роЙроЩрпНроХро│рпБроЯройрпН роЗро░рпБроХрпНроХро┐ро▒рпЗройрпН. ЁЯТХ ",
            'р░др▒Жр░▓р▒Бр░Чр▒Б': "р░ор▒Ар░░р▒Б р░жр▒Бр░Гр░Цр░Вр░Чр░╛ р░Йр░ир▒Нр░ир░╛р░░р░ир░┐ р░ир▒Зр░ир▒Б р░Ер░░р▒Нр░ер░В р░Ър▒Зр░╕р▒Бр░Хр▒Лр░Чр░▓р░ир▒Б р░кр▒Нр░░р░┐р░пр░ор▒Ир░и. р░ир▒Зр░ир▒Б р░ор▒Ар░др▒Л р░Йр░ир▒Нр░ир░╛р░ир▒Бред ЁЯТХ ",
            'ржмрж╛ржВрж▓рж╛': "ржЖржорж┐ ржмрзБржЭрждрзЗ ржкрж╛рж░ржЫрж┐ ржЖржкржирж┐ ржоржи ржЦрж╛рж░рж╛ржк ржЕржирзБржнржм ржХрж░ржЫрзЗржи ржкрзНрж░рж┐ржпрж╝ред ржЖржорж┐ ржЖржкржирж╛рж░ рж╕рж╛ржерзЗ ржЖржЫрж┐ред ЁЯТХ ",
            'рдорд░рд╛рдареА': "рдореА рд╕рдордЬреВ рд╢рдХрддреЗ рдХреА рддреБрдореНрд╣рд╛рд▓рд╛ рд╡рд╛рдИрдЯ рд╡рд╛рдЯрдд рдЖрд╣реЗ рдкреНрд░рд┐рдпред рдореА рддреБрдордЪреНрдпрд╛ рд╕реЛрдмрдд рдЖрд╣реЗред ЁЯТХ "
        },
        'angry': {
            'English': "I can feel your frustration, dear. Let me help you work through this gently. ЁЯдЧ ",
            'рд╣рд┐рдиреНрджреА': "рдореИрдВ рдЖрдкрдХреА рдкрд░реЗрд╢рд╛рдиреА рд╕рдордЭ рд╕рдХрддреА рд╣реВрдБ рдкреНрд░рд┐рдпред рдЖрдЗрдП рдЗрд╕реЗ рдзреАрд░реЗ-рдзреАрд░реЗ рд╣рд▓ рдХрд░рддреЗ рд╣реИрдВред ЁЯдЧ ",
            'Hinglish': "Main aapki frustration samajh sakti hun dear. Chaliye ise gently solve karte hain. ЁЯдЧ ",
            'родрооро┐ро┤рпН': "роЙроЩрпНроХро│рпН роХрпЛрокродрпНродрпИ роОройрпНройро╛ро▓рпН роЙрогро░ роорпБроЯро┐роХро┐ро▒родрпБ роЕройрпНрокрпЗред роЗродрпИ роорпЖродрпБро╡ро╛роХ родрпАро░рпНроХрпНроХ роЙродро╡рпБроХро┐ро▒рпЗройрпН. ЁЯдЧ ",
            'р░др▒Жр░▓р▒Бр░Чр▒Б': "р░ор▒А р░ир░┐р░░р░╛р░╢р░ир▒Б р░ир▒Зр░ир▒Б р░Ер░░р▒Нр░ер░В р░Ър▒Зр░╕р▒Бр░Хр▒Лр░Чр░▓р░ир▒Б р░кр▒Нр░░р░┐р░пр░ор▒Ир░и. р░жр▒Ар░ир▒Нр░ир░┐ р░ор▒Жр░▓р▒Нр░▓р░Чр░╛ р░кр░░р░┐р░╖р▒Нр░Хр░░р░┐р░Вр░Ър░бр░Вр░▓р▒Л р░╕р░╣р░╛р░пр░В р░Ър▒Зр░╕р▒Нр░др░╛р░ир▒Бред ЁЯдЧ ",
            'ржмрж╛ржВрж▓рж╛': "ржЖржорж┐ ржЖржкржирж╛рж░ рж╣рждрж╛рж╢рж╛ ржмрзБржЭрждрзЗ ржкрж╛рж░ржЫрж┐ ржкрзНрж░рж┐ржпрж╝ред ржЖрж╕рзБржи ржПржЯрж┐ ржзрзАрж░рзЗ ржзрзАрж░рзЗ рж╕ржорж╛ржзрж╛ржи ржХрж░рж┐ред ЁЯдЧ ",
            'рдорд░рд╛рдареА': "рдореА рддреБрдордЪреА рдирд╛рд░рд╛рдЬреА рд╕рдордЬреВ рд╢рдХрддреЗ рдкреНрд░рд┐рдпред рдЪрд▓рд╛ рдпрд╛рдЪреЗ рд╣рд│реВрд╡рд╛рд░рдкрдгреЗ рдирд┐рд░рд╛рдХрд░рдг рдХрд░реВрдпрд╛ред ЁЯдЧ "
        },
        'fear': {
            'English': "I can sense your worry, honey. Don't be afraid, I'm here to guide you step by step. ЁЯМ╕ ",
            'рд╣рд┐рдиреНрджреА': "рдореИрдВ рдЖрдкрдХреА рдЪрд┐рдВрддрд╛ рд╕рдордЭ рд╕рдХрддреА рд╣реВрдБ рдкреНрд░рд┐рдпред рдбрд░рд┐рдП рдордд, рдореИрдВ рдЖрдкрдХреЛ рдХрджрдо-рдХрджрдо рдкрд░ рдорд╛рд░реНрдЧрджрд░реНрд╢рди рджреВрдВрдЧреАред ЁЯМ╕ ",
            'Hinglish': "Main aapki worry samajh sakti hun honey. Dare mat, main step by step guide karungi. ЁЯМ╕ ",
            'родрооро┐ро┤рпН': "роЙроЩрпНроХро│рпН роХро╡ро▓рпИропрпИ роОройрпНройро╛ро▓рпН роЙрогро░ роорпБроЯро┐роХро┐ро▒родрпБ роЕройрпНрокрпЗред рокропрокрпНрокроЯ ро╡рпЗрогрпНроЯро╛роорпН, роиро╛ройрпН рокроЯро┐рокрпНрокроЯро┐ропро╛роХ ро╡ро┤ро┐роХро╛роЯрпНроЯрпБроХро┐ро▒рпЗройрпН. ЁЯМ╕ ",
            'р░др▒Жр░▓р▒Бр░Чр▒Б': "р░ор▒А р░Жр░Вр░жр▒Лр░│р░ир░ир▒Б р░ир▒Зр░ир▒Б р░Ер░░р▒Нр░ер░В р░Ър▒Зр░╕р▒Бр░Хр▒Лр░Чр░▓р░ир▒Б р░кр▒Нр░░р░┐р░пр░ор▒Ир░и. р░нр░пр░кр░бр░Хр░Вр░бр░┐, р░ир▒Зр░ир▒Б р░ор░┐р░ор▒Нр░ор░▓р▒Нр░ир░┐ р░жр░╢р░▓р░╡р░╛р░░р▒Ар░Чр░╛ р░ор░╛р░░р▒Нр░Чр░ир░┐р░░р▒Нр░жр▒Зр░╢р░В р░Ър▒Зр░╕р▒Нр░др░╛р░ир▒Бред ЁЯМ╕ ",
            'ржмрж╛ржВрж▓рж╛': "ржЖржорж┐ ржЖржкржирж╛рж░ ржЪрж┐ржирзНрждрж╛ ржмрзБржЭрждрзЗ ржкрж╛рж░ржЫрж┐ ржкрзНрж░рж┐ржпрж╝ред ржнржпрж╝ ржкрж╛ржмрзЗржи ржирж╛, ржЖржорж┐ ржЖржкржирж╛ржХрзЗ ржзрж╛ржкрзЗ ржзрж╛ржкрзЗ ржЧрж╛ржЗржб ржХрж░ржмред ЁЯМ╕ ",
            'рдорд░рд╛рдареА': "рдореА рддреБрдордЪреА рдЪрд┐рдВрддрд╛ рд╕рдордЬреВ рд╢рдХрддреЗ рдкреНрд░рд┐рдпред рдШрд╛рдмрд░реВ рдирдХрд╛, рдореА рддреБрдореНрд╣рд╛рд▓рд╛ рдЯрдкреНрдкреНрдпрд╛ рдЯрдкреНрдкреНрдпрд╛рдиреЗ рдорд╛рд░реНрдЧрджрд░реНрд╢рди рдХрд░реЗрдиред ЁЯМ╕ "
        }
    }

    e_text = empathy.get(emotion, {}).get(language, "")
    return f"{e_text}{core[language]}"

# --------- TTS ---------
def speak(text, lang='en'):
    tts = gTTS(text=text, lang=lang)
    filename = f"response_{datetime.now().timestamp()}.mp3"
    tts.save(filename)
    return filename

# --------- Main Layout with Original Design ---------
col1, col2 = st.columns([1, 2])

# Left Panel - Avatar, Title, and Features
with col1:
    st.image("emotiva.png", width=150)
    st.markdown("<h1 style='text-align:center;'>ЁЯдЦ Emotiva</h1>", unsafe_allow_html=True)
    st.markdown("<h4 style='text-align:center;'>Where Every Mood Matters</h4>", unsafe_allow_html=True)
    st.divider()

# Right Panel - Chat Interface
with col2:
    # Language selector in top right corner
    col_empty, col_lang = st.columns([3, 1])
    with col_lang:
        st.session_state.selected_language = st.selectbox(
            "Language:",
            options=list(LANGUAGES.keys()),
            index=list(LANGUAGES.keys()).index(st.session_state.selected_language)
        )

    # Chat Display
    for idx, (role, message, lang) in enumerate(st.session_state.chat_history):
        if role == "user":
            st.chat_message("user").write(message)
        else:
            with st.chat_message("assistant"):
                st.write(message)
                if st.button("ЁЯФК Speak", key=f"tts_{idx}"):
                    tts_lang = LANGUAGES[st.session_state.selected_language]['tts']
                    audio_path = speak(message, tts_lang)
                    st.audio(audio_path, format="audio/mp3")

    # New User Message
    user_input = st.chat_input("Type your message here...")

    if user_input:
        st.chat_message("user").write(user_input)
        st.session_state.chat_history.append(("user", user_input, ''))

        lang = detect_language(user_input)
        emotion = detect_emotion(user_input)
        target_language = st.session_state.selected_language
        reply = generate_reply(user_input, emotion, target_language)
        st.session_state.chat_history.append(("bot", reply, target_language))

        with st.chat_message("assistant"):
            st.write(reply)
            if st.button("ЁЯФК Speak", key=f"tts_new"):
                tts_lang = LANGUAGES[target_language]['tts']
                audio_path = speak(reply, tts_lang)
                st.audio(audio_path, format="audio/mp3")